# Драйвер устройств "MYDRIVER" для Linux

## Описание проекта
Проект представляет собой загружаемый модуль ядра Linux (LKM - Loadable Kernel Module), реализующий символьное устройство с поддержкой операций чтения/записи и управления через IOCTL. Драйвер включает в себя систему статистики, таймер для периодических операций и параметрическую настройку при загрузке. Проект включает тестовые программы для проверки функциональности.

## Функциональность
### Основные возможности
- **Символьное устройство** - создание файла устройства `/dev/mydriver` для взаимодействия с пользовательским пространством
- **Операции чтения/записи** - поддержка стандартных операций read/write с позиционированием
- **Управление через IOCTL** - получение статистики, очистка счетчиков, запрос размера буфера
- **Параметры модуля** - настройка драйвера через параметры при загрузке (уровень отладки, таймаут таймера, начальное сообщение)
- **Статистика операций** - подсчет количества операций чтения и записи
- **Таймер ядра** - периодическое выполнение операций с настраиваемым интервалом

### Команды IOCTL
| Команда | Код | Описание | Возвращаемые данные |
|---------|-----|----------|---------------------|
| GET_STATS | 0x01 | Получение статистики | Массив из 3 int: [чтения, записи, размер данных] |
| CLEAR_STATS | 0x02 | Очистка статистики | Нет |
| GET_BUFFER_SIZE | 0x03 | Получение размера буфера | Размер буфера драйвера |

## Технические требования
### Системное окружение
- **ОС**: Linux (ядро версии 5.x или новее)
- **Компилятор**: GCC для компиляции модуля ядра
- **Инструменты**: make, заголовочные файлы ядра (kernel-headers)
- **Права**: Требуются права root для загрузки/выгрузки модуля

### Зависимости проекта
```
# Для сборки модуля ядра
build-essential
linux-headers-$(uname -r)
make
gcc
```

## Установка и сборка

### 1. Установка зависимостей
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install build-essential linux-headers-$(uname -r)

# Fedora/RHEL/CentOS
sudo dnf install kernel-devel gcc make
```

### 2. Сборка драйвера
```bash
# Сборка модуля ядра
make

# Очистка сборочных файлов
make clean
```

### 3. Загрузка драйвера
```bash
# Загрузка с параметрами по умолчанию
sudo insmod mydriver.ko

# Загрузка с кастомными параметрами
sudo insmod mydriver.ko debug=1 timeout_ms=3000 init_message="Мой драйвер"

# Проверка загрузки
lsmod | grep mydriver

# Просмотр логов
sudo dmesg | tail -20
```

### 4. Компиляция тестовых программ
```bash
# Основная тестовая программа
gcc -o test_mydriver test_mydriver.c -Wall

# Простая тестовая программа
gcc -o test test.c -Wall
```

## Структура проекта
```
mydriver/
├── mydriver.c           # Исходный код драйвера ядра
├── test_mydriver.c      # Расширенная тестовая программа
├── test.c               # Простая тестовая программа
├── test.sh              # Скрипт автоматического тестирования
├── Makefile             # Файл сборки (необходимо создать)
└── README.md            # Документация
```

### Пример Makefile
```makefile
obj-m += mydriver.o

KDIR := /lib/modules/$(shell uname -r)/build
PWD := $(shell pwd)

all:
	make -C $(KDIR) M=$(PWD) modules

clean:
	make -C $(KDIR) M=$(PWD) clean

test:
	gcc -o test_mydriver test_mydriver.c -Wall
	gcc -o test test.c -Wall
```

## Использование

### Запуск и настройка
1. **Сборка драйвера**: `make`
2. **Загрузка модуля**: `sudo insmod mydriver.ko`
3. **Проверка устройства**: `ls -l /dev/mydriver`
4. **Установка прав**: `sudo chmod 666 /dev/mydriver`
5. **Тестирование**: Запуск тестовых программ

### Основные команды управления
```bash
# Загрузка драйвера
sudo insmod mydriver.ko

# Выгрузка драйвера
sudo rmmod mydriver

# Просмотр параметров модуля
modinfo mydriver.ko

# Просмотр логов ядра
sudo dmesg | grep MYDRIVER
```

### Параметры загрузки модуля
| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| debug | int | 0 | Уровень отладки (0 - выключен, 1 - включен) |
| timeout_ms | int | 5000 | Интервал таймера в миллисекундах |
| init_message | char* | "Hello from driver!" | Начальное сообщение в буфере |

### Пример использования тестовой программы
```bash
# Запуск интерактивного тестера
sudo ./test_mydriver

# Пример сессии:
=== Тест драйвера MYDRIVER ===
1. Прочитать из устройства
2. Записать в устройство
3. Получить статистику (IOCTL)
4. Очистить статистику (IOCTL)
5. Получить размер буфера (IOCTL)
6. Считать с разных позиций
7. Выход
Выбор: 1
```

## Архитектура драйвера

### Основные компоненты
1. **Структура file_operations** - таблица операций драйвера
2. **Буфер данных** - статический буфер размером 1024 байта
3. **Система статистики** - счетчики операций чтения/записи
4. **Таймер ядра** - периодические операции с настраиваемым интервалом
5. **Подсистема IOCTL** - управление драйвером из пользовательского пространства

### Функции драйвера
| Функция | Назначение |
|---------|------------|
| `dev_open()` | Обработка открытия устройства |
| `dev_release()` | Обработка закрытия устройства |
| `dev_read()` | Чтение данных из буфера драйвера |
| `dev_write()` | Запись данных в буфер драйвера |
| `dev_ioctl()` | Обработка команд управления |
| `timer_callback()` | Обработчик срабатывания таймера |
| `mydriver_init()` | Инициализация модуля |
| `mydriver_exit()` | Выгрузка модуля |

## Безопасность

### Защита данных
- **Проверка границ** - контроль доступа к буферу при чтении/записи
- **Копирование данных** - использование `copy_to_user`/`copy_from_user` для безопасного переноса данных
- **Блокировки** - для многопоточного доступа (не реализовано в текущей версии)

### Ограничения
- Статический буфер фиксированного размера
- Нет поддержки нескольких одновременных открытий с разделением состояний
- Базовые проверки прав доступа

## Особенности реализации

### Технические решения
1. **Динамическое выделение major номера** - через `alloc_chrdev_region()`
2. **Класс устройств** - автоматическое создание узла в `/dev/` через `device_create()`
3. **Позиционирование** - поддержка `lseek()` через параметр offset
4. **Параметры модуля** - настройка через `module_param()`

### Обработка ошибок
- Проверка возвращаемых значений системных вызовов
- Обработка ошибок копирования в/из пользовательского пространства
- Ведение логов через `printk()` с уровнем отладки

## Разработка и расширение

### Добавление новых функций
1. **Расширение IOCTL** - добавление новых команд управления
2. **Динамический буфер** - выделение памяти через `kmalloc()`
3. **Поддержка `poll()`** - для асинхронного ввода/вывода
4. **Сигналы** - уведомление пользовательских процессов о событиях

### Улучшение производительности
1. **Кольцевой буфер** - для эффективной обработки потоковых данных
2. **Кэширование** - уменьшение количества копирований данных
3. **Прерывания** - обработка аппаратных прерываний (для реальных устройств)

## Тестирование

### Автоматическое тестирование
```bash
# Запуск тестового скрипта
chmod +x test.sh
sudo ./test.sh
```

### Ручное тестирование
```bash
# 1. Проверка чтения
cat /dev/mydriver

# 2. Проверка записи
echo "Test message" > /dev/mydriver

# 3. Проверка IOCTL через тестовую программу
sudo ./test_mydriver

# 4. Проверка позиционирования
dd if=/dev/mydriver bs=10 count=1 skip=5
```

### Тестовые сценарии
1. **Базовые операции** - чтение/запись в разных позициях
2. **Граничные условия** - чтение за пределами данных, запись в полный буфер
3. **Многопоточный доступ** - одновременный доступ из нескольких процессов
4. **Долгая работа** - проверка на утечки памяти и стабильность


## Отладка и диагностика

### Инструменты отладки
```bash
# Просмотр логов ядра
sudo dmesg -w

# Проверка загруженных модулей
lsmod

# Информация о модуле
modinfo mydriver.ko

# Статус устройства
ls -l /dev/mydriver
cat /proc/devices | grep mydriver
```

### Распространенные проблемы и решения
1. **Ошибка загрузки**: Проверьте версию ядра и заголовочные файлы
2. **Нет устройства в /dev/**: Проверьте создание класса и устройства в `mydriver_init()`
3. **Permission denied**: Установите права `sudo chmod 666 /dev/mydriver`
4. **Ошибки компиляции**: Убедитесь в наличии заголовочных файлов ядра

## Лицензия
Проект распространяется под лицензией GPL, как указано в модуле драйвера.

## Дополнительные материалы
- [Документация по разработке драйверов Linux](https://www.kernel.org/doc/html/latest/)
- [Руководство по LKM](https://tldp.org/LDP/lkmpg/2.6/html/)
- [Linux Device Drivers, 3rd Edition](https://lwn.net/Kernel/LDD3/)
